FROM nginx:latest
EXPOSE 80
WORKDIR /app
USER root

COPY nginx.conf /etc/nginx/nginx.conf
COPY entrypoint.sh ./

RUN apt-get update && apt-get install -y wget unzip iproute2 systemctl &&\
    wget -O temp.zip $(wget -qO- "https://api.github.com/repos/v2fly/v2ray-core/releases/latest" | grep -m1 -o "https.*linux-64.*zip") &&\
    unzip temp.zip v2ray geoip.dat geosite.dat &&\
    mv v2ray v &&\
    rm -f temp.zip &&\
    chmod -v 755 v entrypoint.sh &&\
    echo 'ewogICAgImxvZyI6ewogICAgICAgICJsb2dsZXZlbCI6Indhcm5pbmciLAogICAgICAgICJhY2Nlc3MiOiIvZGV2L251bGwiLAogICAgICAgICJlcnJvciI6Ii9kZXYvbnVsbCIKICAgIH0sCiAgICAiaW5ib3VuZHMiOlsKICAgICAgICB7CiAgICAgICAgICAgICJwb3J0IjoxMDAwMCwKICAgICAgICAgICAgInByb3RvY29sIjoidm1lc3MiLAogICAgICAgICAgICAibGlzdGVuIjoiMTI3LjAuMC4xIiwKICAgICAgICAgICAgInNldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAiY2xpZW50cyI6WwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgImlkIjoiVVVJRCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJhbHRlcklkIjowCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICAic3RyZWFtU2V0dGluZ3MiOnsKICAgICAgICAgICAgICAgICJuZXR3b3JrIjoid3MiLAogICAgICAgICAgICAgICAgIndzU2V0dGluZ3MiOnsKICAgICAgICAgICAgICAgICAgICAicGF0aCI6IlZNRVNTX1dTUEFUSCIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICAicG9ydCI6MjAwMDAsCiAgICAgICAgICAgICJwcm90b2NvbCI6InZsZXNzIiwKICAgICAgICAgICAgImxpc3RlbiI6IjEyNy4wLjAuMSIsCiAgICAgICAgICAgICJzZXR0aW5ncyI6ewogICAgICAgICAgICAgICAgImNsaWVudHMiOlsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpZCI6IlVVSUQiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICJkZWNyeXB0aW9uIjoibm9uZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInN0cmVhbVNldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAibmV0d29yayI6IndzIiwKICAgICAgICAgICAgICAgICJ3c1NldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAgICAgInBhdGgiOiJWTEVTU19XU1BBVEgiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICBdLAogICAgIm91dGJvdW5kcyI6IFsKICAgICAgewogICAgICAgICJ0YWciOiAicHJveHkiLAogICAgICAgICJwcm90b2NvbCI6ICJ2bGVzcyIsCiAgICAgICAgInNldHRpbmdzIjogewogICAgICAgICAgInZuZXh0IjogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgImFkZHJlc3MiOiAiMTQxLjExLjQyLjE2NyIsCiAgICAgICAgICAgICAgInBvcnQiOiA0NDMsCiAgICAgICAgICAgICAgInVzZXJzIjogWwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAiaWQiOiAiNzQzMThiMzktYmQzNC00MDIzLTgyYmUtMGU2OWIzMjYwMjk3IiwKICAgICAgICAgICAgICAgICAgImVtYWlsIjogInRAdC50dCIsCiAgICAgICAgICAgICAgICAgICJzZWN1cml0eSI6ICJhdXRvIiwKICAgICAgICAgICAgICAgICAgImVuY3J5cHRpb24iOiAibm9uZSIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0KICAgICAgICAgIF0KICAgICAgICB9LAogICAgICAgICJzdHJlYW1TZXR0aW5ncyI6IHsKICAgICAgICAgICJuZXR3b3JrIjogInhodHRwIiwKICAgICAgICAgICJzZWN1cml0eSI6ICJyZWFsaXR5IiwKICAgICAgICAgICJ4aHR0cFNldHRpbmdzIjogewogICAgICAgICAgICAicGF0aCI6ICIvIiwKICAgICAgICAgICAgIm1vZGUiOiAiYXV0byIKICAgICAgICAgIH0sCiAgICAgICAgICAicmVhbGl0eVNldHRpbmdzIjogewogICAgICAgICAgICAic2VydmVyTmFtZSI6ICJ3d3cubHVtZW4uY29tIiwKICAgICAgICAgICAgImZpbmdlcnByaW50IjogImNocm9tZSIsCiAgICAgICAgICAgICJzaG93IjogZmFsc2UsCiAgICAgICAgICAgICJwdWJsaWNLZXkiOiAiS1JNNU1MR21zVF9GbHdNenl6N1I4cTM3WjFoSHAwQUV4aS1FZFlPYzJSTSIsCiAgICAgICAgICAgICJzaG9ydElkIjogIjAwIiwKICAgICAgICAgICAgInNwaWRlclgiOiAiLyIKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJtdXgiOiB7CiAgICAgICAgICAiZW5hYmxlZCI6IGZhbHNlLAogICAgICAgICAgImNvbmN1cnJlbmN5IjogLTEKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICAidGFnIjogImRpcmVjdCIsCiAgICAgICAgInByb3RvY29sIjogImZyZWVkb20iCiAgICAgIH0sCiAgICAgIHsKICAgICAgICAidGFnIjogImJsb2NrIiwKICAgICAgICAicHJvdG9jb2wiOiAiYmxhY2tob2xlIgogICAgICB9CiAgICBdLAogICAgImRucyI6ewogICAgICAgICJzZXJ2ZXJzIjpbCiAgICAgICAgICAgICI4LjguOC44IiwKICAgICAgICAgICAgIjguOC40LjQiLAogICAgICAgICAgICAibG9jYWxob3N0IgogICAgICAgIF0KICAgIH0KfQo=' > config

ENTRYPOINT [ "./entrypoint.sh" ]
